"use strict";geotab.addin.startStop=function(){var d,i,r,c,l,s,u,a,D=2e3,S=.1,f=function(n){a=n,d.call("Get",{typeName:"Device",search:{groups:i.getGroupFilter(),fromDate:(new Date).toISOString()}},function(e){var t=e.sort(function(e,t){return e.name.toLowerCase().localeCompare(t.name.toLowerCase())}).map(function(e){return{name:e.name,id:e.id}});a===n&&a(t)},function(e){alert(e)})};function m(n,a,o){return new Promise(function(e,t){d.call("Get",{typeName:"Trip",search:{deviceSearch:{id:n},fromDate:a,toDate:o}},e,t)})}function g(e,t,n,a){var o=t/1e3/60*n;a=a||"",r=document.getElementById("stopStart-times"+a),c=document.getElementById("stopStart-idling"+a),document.getElementById("stopStart-fuel"+a).innerText=-1===e?(r.innerText="-",c.innerText="-:--","-"):(r.innerText=Math.round(e),c.innerText=function(e){var t=parseInt(e,10),n=Math.floor(t/3600),a=Math.floor((t-3600*n)/60);a<10&&(a="0"+a);return n+":"+a}(t/1e3),Math.round(o*l*100)/100)}function h(e,t,n){g(e,t,n,"-annual")}function p(){g(-1),h(-1),""!==this.value&&function(i){document.getElementById("stopStart-vehicleSelect").disabled=!0;var r=new Date,c=new Date;c.setDate(r.getDate()-1);var l=0,s=0,u=0;t(30,function(a){var t,n,o;(t=i,n=c,o=r,new Promise(function(v,e){d.multiCall([["Get",{typeName:"StatusData",search:{deviceSearch:{id:t},fromDate:n.toISOString(),toDate:o.toISOString()}}],["Get",{typeName:"LogRecord",search:{deviceSearch:{id:t},fromDate:n,toDate:o}}]],function(e){var t,n,a,o=e[0],i=e[1],r=!1,c=!1,l=!1,s=null,u=null,d=null,f=0,m=0,g=[],h=o.filter(function(e){switch(e.diagnostic.id){case"DiagnosticVehicleActiveId":case"DiagnosticEngineSpeedId":case"DiagnosticTotalTripIdleFuelUsedId":return!0;default:return!1}});for((h=(h=h.concat(i)).map(function(e){return e.dateTime=new Date(e.dateTime),e})).sort(function(e,t){return e.dateTime-t.dateTime}),n=0;n<h.length;n++){if((t=h[n]).diagnostic)switch(t.diagnostic.id){case"DiagnosticVehicleActiveId":r=1===t.data;break;case"DiagnosticEngineSpeedId":c=0<t.data;break;case"DiagnosticTotalTripIdleFuelUsedId":m+=t.data}else l=0!==t.speed;if(!l&&c&&null==d&&(d=t.dateTime),null===d||!l&&c||(f+=t.dateTime-d,d=null),!r||c||a){if(a&&(!r||c)){var p=(u=t.dateTime)-s;D<p&&g.push({fromDate:s,duration:u-s}),a=!1}}else a=!0,s=t.dateTime}v({fuelUsedPerMinuteIdling:0<f&&S<m?m/(f/1e3/60):0,stopStarts:g})},e)})).then(function(e){var t=e.stopStarts,n=e.fuelUsedPerMinuteIdling;0<(s+=t.length)&&(t.forEach(function(e){l+=e.duration}),0<n&&(u=0===u?n:(u+n)/2),g(s,l,u)),c.setDate(c.getDate()-1),r.setDate(r.getDate()-1),a.next()})},function(){c=new Date,r=new Date,c.setDate(c.getDate()-30),m(i,c,r).then(function(e){var n,a,o=0;e.forEach(function(e){o+=e.distance}),0<o?(h((n=s/o)*o,(a=l/o)*o,u),t(11,function(t){m(i,c,r).then(function(e){e.forEach(function(e){o+=e.distance}),h(n*o,a*o,u),c.setDate(c.getDate()-30),r.setDate(r.getDate()-30),t.next()})},function(){document.getElementById("stopStart-vehicleSelect").disabled=!1})):document.getElementById("stopStart-vehicleSelect").disabled=!1})})}(this.value)}function t(e,t,n){var a=0,o=!1,i={next:function(){o||(a<e?(a++,t(i)):(o=!0,n()))},iteration:function(){return a-1},break:function(){o=!0,n()}};return i.next(),i}return{initialize:function(e,t,n){d=e,i=t,u=document.getElementById("startStop"),i.translate&&i.translate(u||""),n()},focus:function(e,t){var n,a,o;d=e,i=t,g(-1),n=function(){var n;n=function(){document.getElementById("stopStart-volume-label").innerHTML=s,document.getElementById("stopStart-volume-label-annual").innerHTML=s,console.log("updateDashboardRegionalUnits"),u.style.display="block"},d.getSession(function(e){var t=e.userName;d.call("Get",{typeName:"User",search:{name:t}},function(e){if(0===e.length)throw new Error("Unable to find currently logged on user.");var t=e[0];switch(t.fuelEconomyUnit){case"LitersPer100Km":case"KmPerLiter":l=1,s=i.translate("Liters");break;case"MPGUS":l=1/3.785411784,s=i.translate("Gallons (US)");break;case"MPGImperial":l=1/4.54609,s=i.translate("Gallons (UK)");break;default:l=1,s=i.translate("Liters")}console.log(t.isMetric),console.log(t.fuelEconomyUnit),console.log(t.language),console.log(t.dateFormat),console.log(t.timeZoneId),n()},function(e){throw"Error while trying to load currently logged on user. "+e})})},(o=document.getElementById("stopStart-vehicleSelect")).innerHTML="",o.removeEventListener("change",p),o.appendChild(((a=document.createElement("option")).default=!0,a.selected=!0,a.value="",a.textContent=i.translate("Select a vehicle..."),a)),f(function(e){e.forEach(function(e){var t=document.createElement("option");t.value=e.id,t.textContent=e.name,o.appendChild(t)}),o.addEventListener("change",p),n()})},blur:function(){u.style.display="none"}}};